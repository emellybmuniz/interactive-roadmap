<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roadmap Customiz√°vel com IA ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              slate: { 850: "#1f2937" },
            },
          },
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .spinning {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }
      .dragging {
        opacity: 0.5;
      }
      .drop-indicator {
        height: 2px;
        background-color: #14b8a6;
        margin: 4px 0;
        border-radius: 2px;
      }

      .dark ::-webkit-scrollbar {
        width: 8px;
      }
      .dark ::-webkit-scrollbar-track {
        background: #0f172a;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 4px;
      }
      .dark ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
    </style>
  </head>

  <body
    class="bg-slate-50 text-slate-700 dark:bg-slate-900 dark:text-slate-300 transition-colors duration-300 ease-in-out"
  >
    <button
      id="sidebar-toggle-open"
      class="md:hidden fixed top-4 left-4 z-30 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-2 rounded-md shadow-lg text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white transition-all duration-300"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"
        ></path>
      </svg>
    </button>

    <div class="flex min-h-screen">
      <aside
        id="sidebar"
        class="bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 p-6 fixed top-0 left-0 h-full flex flex-col transition-all duration-300 ease-in-out z-40 -translate-x-full md:translate-x-0"
        style="width: 328px"
      >
        <div class="flex justify-between items-center mb-6">
          <h1
            class="text-xl font-bold text-slate-800 dark:text-slate-100 transition-colors duration-300"
          >
            Fases do Roadmap
          </h1>
          <button
            id="sidebar-toggle-close"
            class="md:hidden text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors text-3xl leading-none"
          >
            &times;
          </button>
        </div>

        <nav class="flex-grow overflow-y-auto">
          <ul id="sidebar-nav" class="space-y-2"></ul>
        </nav>

        <div
          class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 flex-shrink-0 space-y-3 transition-colors duration-300"
        >
          <button
            onclick="showFormModal({ type: 'phase', mode: 'add' })"
            class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors duration-300 font-semibold mb-3"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              ></path>
            </svg>
            Adicionar Fase
          </button>

          <div class="guest-only space-y-3">
            <button
              onclick="showAuthModal('register')"
              class="w-full px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 font-semibold transition-colors"
            >
              Salvar Roadmap
            </button>

            <button
              onclick="showAuthModal('login')"
              class="w-full px-4 py-2 text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 font-medium border border-teal-600 dark:border-teal-500 rounded-lg hover:bg-teal-50 dark:hover:bg-slate-700/50 transition-colors duration-300"
            >
              Carregar Roadmap
            </button>
            <p
              class="text-xs text-slate-500 dark:text-slate-400 text-center pb-2 transition-colors duration-300"
            >
              Crie uma conta para salvar e acessar seu progresso de qualquer
              lugar.
            </p>
          </div>
        </div>

        <div
          class="auth-only space-y-3 mt-2 pt-4 border-slate-200 dark:border-slate-700"
          style="display: none"
        >
          <div
            id="sync-status"
            class="sync-indicator flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 transition-colors duration-300"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              ></path>
            </svg>
            <span id="sync-text">Sincronizado</span>
          </div>
        </div>
      </aside>

      <div
        id="resizer"
        class="w-1.5 cursor-col-resize bg-slate-200/50 dark:bg-slate-700/50 hover:bg-teal-400 transition-colors duration-200 fixed top-0 h-full z-20 hidden md:block"
        style="left: 328px"
      ></div>

      <main
        id="main-content"
        class="flex-1 p-4 sm:p-6 md:p-8 transition-all duration-300 ease-in-out"
      >
        <header class="mb-8">
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
          >
            <div class="">
                <h1
                class="text-4xl font-bold text-slate-900 dark:text-white mb-2 transition-colors duration-300 pt-12 md:pt-0"
                >
                Roadmap de Desenvolvimento Tech
                </h1>
              <p
                class="text-lg text-slate-500 dark:text-slate-400 transition-colors duration-300"
              >
                Uma jornada visual e interativa, com o poder da IA ‚ú® integrada
                para acelerar seu aprendizado.
              </p>
            </div>

            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2">
                <svg
                  class="w-5 h-5 text-slate-500 dark:text-slate-400 transition-colors duration-300"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                  ></path>
                </svg>
                <label
                  for="theme-toggle"
                  class="relative inline-flex items-center cursor-pointer"
                >
                  <input
                    type="checkbox"
                    value=""
                    id="theme-toggle"
                    class="sr-only peer"
                  />
                  <div
                    class="w-11 h-6 bg-slate-200 dark:bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500 transition-colors duration-300"
                  ></div>
                </label>
                <svg
                  class="w-5 h-5 text-slate-500 dark:text-slate-400 transition-colors duration-300"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                  ></path>
                </svg>
              </div>

              <div class="auth-only relative" style="display: none">
                <button
                  id="user-menu-button"
                  class="flex items-center gap-3 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-full py-1.5 px-3 transition-colors duration-300"
                >
                  <span
                    id="user-name-display"
                    class="font-semibold text-slate-700 dark:text-slate-200"
                  ></span>
                  <div
                    class="w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center text-white font-bold"
                    id="user-avatar"
                  ></div>
                </button>
                <div
                  id="user-menu-dropdown"
                  class="absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 opacity-0 invisible transition-all duration-200 transform origin-top-right scale-95 z-50"
                >
                  <div
                    class="p-4 border-b border-slate-200 dark:border-slate-700"
                  >
                    <p
                      class="font-semibold text-slate-800 dark:text-white"
                      id="user-menu-name"
                    ></p>
                    <p
                      class="text-sm text-slate-500 dark:text-slate-400"
                      id="user-menu-email"
                    ></p>
                  </div>
                  <div class="p-2">
                    <button
                      onclick="AuthManager.deleteAccount()"
                      class="w-full text-left px-3 py-2 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-slate-700 rounded-md transition-colors flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-4v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                        ></path>
                      </svg>
                      Deletar Conta
                    </button>
                    <button
                      onclick="AuthManager.logout()"
                      class="w-full text-left px-3 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md transition-colors flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                      </svg>
                      Sair
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <section id="dashboard" class="mb-12">
          <h2
            class="text-2xl font-semibold text-slate-800 dark:text-white mb-4 border-b border-slate-200 dark:border-slate-700 pb-2 transition-colors duration-300"
          >
            Painel de Progresso üéØ
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <div
              class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm transition-colors duration-300"
            >
              <h3
                class="font-semibold text-center mb-4 text-slate-800 dark:text-slate-200"
              >
                Progresso Geral
              </h3>
              <div class="chart-container">
                <canvas id="overallProgressChart"></canvas>
              </div>
              <div
                id="stats"
                class="text-center mt-4 transition-colors duration-300"
              ></div>
            </div>
            <div
              class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm xl:col-span-2 transition-colors duration-300"
            >
              <h3
                class="font-semibold text-left mb-4 text-slate-800 dark:text-slate-200"
              >
                Progresso por Fase
              </h3>
              <div class="bar-chart-container">
                <canvas id="phaseProgressChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <div id="roadmap-content" class="space-y-12"></div>
      </main>
    </div>

    <div
      id="sidebar-overlay"
      class="md:hidden fixed inset-0 bg-black/50 z-30 hidden"
    ></div>

    <div
      id="gemini-modal"
      class="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transition-colors duration-300"
      >
        <header
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center flex-shrink-0"
        >
          <h3
            id="gemini-modal-title"
            class="text-lg font-semibold text-slate-800 dark:text-white"
          ></h3>
          <button
            onclick="hideModal('gemini-modal')"
            class="text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors"
          >
            &times;
          </button>
        </header>
        <div class="p-6 overflow-y-auto">
          <div
            id="gemini-modal-loader"
            class="flex justify-center items-center h-48"
          >
            <div
              class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-teal-500"
            ></div>
          </div>
          <div
            id="gemini-modal-text"
            class="text-slate-600 dark:text-slate-300 leading-relaxed space-y-4"
          ></div>
        </div>
      </div>
    </div>

    <div
      id="form-modal"
      class="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg transition-colors duration-300"
      >
        <header
          class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center"
        >
          <h3
            id="form-modal-title"
            class="text-lg font-semibold text-slate-800 dark:text-white"
          ></h3>
          <button
            onclick="hideModal('form-modal')"
            class="text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors"
          >
            &times;
          </button>
        </header>
        <div id="form-modal-content" class="p-6"></div>
      </div>
    </div>

    <div
      id="confirm-modal"
      class="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center p-4 hidden backdrop-blur-sm transition-opacity"
    >
      <div
        class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm transition-colors duration-300"
      >
        <header class="p-4 flex justify-between items-center">
          <h3
            id="confirm-modal-title"
            class="text-lg font-semibold text-red-600 dark:text-red-400"
          ></h3>
          <button
            onclick="hideModal('confirm-modal')"
            class="text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors"
          >
            &times;
          </button>
        </header>
        <div class="p-6 pt-0">
          <p
            id="confirm-modal-text"
            class="text-slate-600 dark:text-slate-300 mb-6"
          ></p>
          <div class="flex justify-end gap-4">
            <button
              id="confirm-modal-cancel"
              class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors"
            >
              Cancelar
            </button>
            <button
              id="confirm-modal-confirm"
              class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
            >
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let roadmapData = [
        {
          phase: "0",
          title: "Fundamentos",
          description: "Base do conhecimento t√©cnico.",
          items: [
            { text: "Mentalidade Orientada a Problemas", checked: true },
            {
              text: "Git & GitHub: Fundamentos de versionamento de c√≥digo.",
              checked: true,
            },
            { text: "Linha de Comando (CLI)", checked: true },
            { text: "HTTP/HTTPS", checked: true },
            { text: "JSON", checked: true },
            { text: "Cloud: Conceitos b√°sicos", checked: false },
            { text: "SQL: Fundamentos de bancos de dados", checked: false },
            {
              text: "Gerenciamento de Pacotes",
              checked: false,
              subItems: [
                { text: "npm / Yarn", checked: true },
                { text: "venv (Python)", checked: false },
                { text: "Maven / Gradle (Java)", checked: false },
              ],
            },
          ],
        },
        {
          phase: "1",
          title: "Desenvolvimento Front-End",
          description: "Construindo a interface visual.",
          items: [
            { text: "HTML", checked: true },
            { text: "CSS", checked: true },
            { text: "JavaScript: Fundamentos", checked: true },
            { text: "Manipula√ß√£o do DOM", checked: true },
            { text: "Assincronicidade", checked: false },
            { text: "TypeScript", checked: false },
            {
              text: "Frameworks",
              checked: false,
              subItems: [
                { text: "React.js", checked: false },
                { text: "Next.js", checked: false },
              ],
            },
            {
              text: "Ferramentas de Build",
              checked: false,
              subItems: [
                { text: "Webpack", checked: false },
                { text: "Vite", checked: false },
              ],
            },
          ],
        },
        {
          phase: "2",
          title: "Desenvolvimento Back-End",
          description: "Criando a l√≥gica do servidor.",
          items: [
            { text: "Node.js", checked: false },
            { text: "Express.js", checked: false },
            { text: "APIs: REST e GraphQL", checked: false },
            { text: "Autentica√ß√£o", checked: false },
            { text: "Banco de Dados", checked: false },
            {
              text: "NoSQL",
              checked: false,
              subItems: [
                { text: "MongoDB", checked: true },
                { text: "Mongoose", checked: false },
              ],
            },
          ],
        },
        {
          phase: "3",
          title: "Testes e Qualidade",
          description: "Garantindo a funcionalidade do c√≥digo.",
          items: [
            { text: "Jest", checked: false },
            { text: "Cypress", checked: false },
            { text: "ESLint", checked: true },
            { text: "Prettier", checked: true },
          ],
        },
        {
          phase: "4",
          title: "Infraestrutura e DevOps",
          description: "Implantando e gerenciando aplica√ß√µes.",
          items: [
            { text: "Docker", checked: false },
            { text: "Kubernetes", checked: false },
            { text: "CI/CD", checked: false },
            { text: "AWS", checked: true },
            { text: "Azure", checked: false },
          ],
        },
      ];

      const modals = ["gemini-modal", "form-modal", "confirm-modal"];
      let overallChartInstance = null;
      let phaseChartInstance = null;

      const API_BASE_URL =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
          ? "http://localhost:3000/api"
          : "/api";

      const ThemeManager = {
        init() {
          this.toggle = document.getElementById("theme-toggle");
          if (!this.toggle) return;

          if (
            localStorage.theme === "dark" ||
            (!("theme" in localStorage) &&
              window.matchMedia("(prefers-color-scheme: dark)").matches)
          ) {
            document.documentElement.classList.add("dark");
            this.toggle.checked = true;
          } else {
            document.documentElement.classList.remove("dark");
            this.toggle.checked = false;
          }

          this.toggle.addEventListener("change", () => {
            if (this.toggle.checked) {
              document.documentElement.classList.add("dark");
              localStorage.theme = "dark";
            } else {
              document.documentElement.classList.remove("dark");
              localStorage.theme = "light";
            }
            this.updateCharts();
          });
        },

        isDarkMode() {
          return document.documentElement.classList.contains("dark");
        },

        updateCharts() {
          const isDark = this.isDarkMode();
          const textColor = isDark ? "#cbd5e1" : "#475569";
          const gridColor = isDark ? "#334155" : "#e2e8f0";
          const tooltipBgColor = isDark ? "#1e293b" : "#ffffff";
          const tooltipTitleColor = isDark ? "#f1f5f9" : "#1e293b";

          if (overallChartInstance) {
            overallChartInstance.data.datasets[0].backgroundColor = [
              isDark ? "#0d9488" : "#14b8a6",
              isDark ? "#334155" : "#e2e8f0",
            ];
            overallChartInstance.data.datasets[0].borderColor = isDark
              ? "#1e293b"
              : "#ffffff";
            overallChartInstance.options.plugins.tooltip.backgroundColor =
              tooltipBgColor;
            overallChartInstance.options.plugins.tooltip.titleColor =
              tooltipTitleColor;
            overallChartInstance.options.plugins.tooltip.bodyColor = textColor;
            overallChartInstance.update();
          }
          if (phaseChartInstance) {
            phaseChartInstance.data.datasets[0].backgroundColor = isDark
              ? "#2dd4bf"
              : "#5eead4";
            phaseChartInstance.options.scales.x.ticks.color = textColor;
            phaseChartInstance.options.scales.x.grid.color = gridColor;
            phaseChartInstance.options.scales.y.ticks.color = textColor;
            phaseChartInstance.options.scales.y.grid.color = gridColor;
            phaseChartInstance.options.plugins.tooltip.backgroundColor =
              tooltipBgColor;
            phaseChartInstance.options.plugins.tooltip.titleColor =
              tooltipTitleColor;
            phaseChartInstance.options.plugins.tooltip.bodyColor = textColor;
            phaseChartInstance.update();
          }

          const statsEl = document.getElementById("stats-text");
          if (statsEl)
            statsEl.className = `text-4xl font-bold ${
              isDark ? "text-white" : "text-slate-800"
            } transition-colors duration-300`;
        },
      };

      const AuthManager = {
        token: localStorage.getItem("authToken"),
        currentUser: null,
        isSyncing: false,

        async init() {
          if (this.token) {
            const isValid = await this.validateToken();
            if (isValid) {
              await this.loadUserData();
              this.showAuthenticatedUI();
              await this.loadRoadmapFromServer();
            } else {
              this.logout();
            }
          } else {
            this.showGuestUI();
          }
        },

        async validateToken() {
          try {
            const response = await fetch(`${API_BASE_URL}/auth/me`, {
              headers: { Authorization: `Bearer ${this.token}` },
            });
            return response.ok;
          } catch (error) {
            return false;
          }
        },

        async loadUserData() {
          try {
            const response = await fetch(`${API_BASE_URL}/auth/me`, {
              headers: { Authorization: `Bearer ${this.token}` },
            });
            if (response.ok) {
              const data = await response.json();
              this.currentUser = data.user;
              this.updateUserDisplay();
            }
          } catch (error) {
            console.error("Erro ao carregar dados:", error);
          }
        },

        async register(name, email, password) {
          try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email, password, roadmapData }),
            });
            const data = await response.json();
            if (response.ok) {
              this.token = data.token;
              this.currentUser = data.user;
              localStorage.setItem("authToken", data.token);
              this.showAuthenticatedUI();
              this.updateSyncStatus("synced");
              return { success: true, message: data.message };
            }
            return { success: false, message: data.message };
          } catch (error) {
            return { success: false, message: "Erro ao conectar com o servidor." };
          }
        },

        async login(email, password) {
          try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });
            const data = await response.json();
            if (response.ok) {
              this.token = data.token;
              this.currentUser = data.user;
              localStorage.setItem("authToken", data.token);
              this.showAuthenticatedUI();
              await this.loadRoadmapFromServer();
              return { success: true, message: data.message };
            }
            return { success: false, message: data.message };
          } catch (error) {
            return {
              success: false,
              message: "Erro ao conectar com o servidor.",
            };
          }
        },

        async logout() {
          if (this.isSyncing) return;
          await this.saveRoadmapToServer(); 
          this.token = null;
          this.currentUser = null;
          localStorage.removeItem("authToken");
          this.showGuestUI();
          window.location.reload();
        },

        async deleteAccount() {
                      showConfirmModal({
              title: "Deletar Conta",
              text: "Tem certeza que deseja deletar sua conta? Esta a√ß√£o n√£o pode ser desfeita e todo o seu progresso ser√° perdido.",
              onConfirm: async () => {
                try {
                  const response = await fetch(`${API_BASE_URL}/auth/delete`, {
                    method: "DELETE",
                    headers: { Authorization: `Bearer ${this.token}` },
                  });
                  if (response.ok) {
                    alert("Conta deletada com sucesso!");
                    await this.logout();
                  } else { alert("Erro ao deletar conta."); }
                } catch (error) { alert("Erro ao deletar conta."); }
            },
            });
        },

        async loadRoadmapFromServer() {
          try {
            const response = await fetch(`${API_BASE_URL}/roadmap`, {
              headers: { Authorization: `Bearer ${this.token}` },
            });
            if (response.ok) {
              const data = await response.json();
              roadmapData = data.roadmap;
              renderApp();
            } else if (response.status === 404) {
              await this.saveRoadmapToServer();
            }
          } catch (error) {
            console.error("Erro ao carregar roadmap:", error);
          }
        },

        async saveRoadmapToServer() {
          if (!this.token || this.isSyncing) return;
          this.isSyncing = true;
          this.updateSyncStatus("syncing");
          try {
            const response = await fetch(`${API_BASE_URL}/roadmap`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${this.token}`,
              },
              body: JSON.stringify({ roadmapData }),
            });
            if (response.ok) this.updateSyncStatus("synced");
            else this.updateSyncStatus("error");
          } catch (error) {
            this.updateSyncStatus("error");
          } finally {
            this.isSyncing = false;
          }
        },

        updateSyncStatus(status) {
          const indicator = document.getElementById("sync-status");
          const text = document.getElementById("sync-text");
          if (!indicator || !text) return;
          indicator.classList.remove("syncing");
          const icon = indicator.querySelector("svg");
          if (status === "syncing") {
            indicator.classList.add("syncing");
            text.textContent = "Salvando...";
            icon.classList.add("spinning");
          } else if (status === "synced") {
            text.textContent = "Sincronizado";
            icon.classList.remove("spinning");
          } else {
            text.textContent = "Erro ao salvar";
            icon.classList.remove("spinning");
          }
        },

        updateUserDisplay() {
          const nameEl = document.getElementById("user-name-display");
          const avatarEl = document.getElementById("user-avatar");
          const menuNameEl = document.getElementById("user-menu-name");
          const menuEmailEl = document.getElementById("user-menu-email");
          if (this.currentUser) {
            if (nameEl)
              nameEl.textContent = this.currentUser.name.split(" ")[0];
            if (avatarEl)
              avatarEl.textContent = this.currentUser.name
                .charAt(0)
                .toUpperCase();
            if (menuNameEl) menuNameEl.textContent = this.currentUser.name;
            if (menuEmailEl) menuEmailEl.textContent = this.currentUser.email;
          }
        },

        showAuthenticatedUI() {
          document
            .querySelectorAll(".guest-only")
            .forEach((el) => (el.style.display = "none"));
          document
            .querySelectorAll(".auth-only")
            .forEach((el) => (el.style.display = "block"));
          this.updateUserDisplay();
        },

        showGuestUI() {
          document
            .querySelectorAll(".guest-only")
            .forEach((el) => (el.style.display = "block"));
          document
            .querySelectorAll(".auth-only")
            .forEach((el) => (el.style.display = "none"));
        },
      };
      
      window.addEventListener("beforeunload", (e) => {
        if (AuthManager.token && AuthManager.isSyncing) {
          const confirmationMessage = "Suas altera√ß√µes ainda est√£o sendo salvas. Deseja realmente sair?";
          (e || window.event).returnValue = confirmationMessage;
          return confirmationMessage;
        }
      });

      function showAuthModal(mode = "login") {
        const title = mode === "login" ? "Entrar" : "Criar Conta";
        const buttonText = mode === "login" ? "Entrar" : "Registrar";
        const switchText =
          mode === "login"
            ? "N√£o tem uma conta? Registre-se"
            : "J√° possui uma conta? Fa√ßa login";

        document.getElementById("form-modal-title").textContent = title;
        document.getElementById("form-modal-content").innerHTML = `
                <form id="auth-form" class="space-y-4">
                    ${
                      mode === "register"
                        ? `<div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Nome</label>
                        <input type="text" id="auth-name" required class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition-colors">
                    </div>`
                        : ""
                    }
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Email</label>
                        <input type="email" id="auth-email" required class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Senha</label>
                        <input type="password" id="auth-password" required minlength="6" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition-colors">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">M√≠nimo 6 caracteres</p>
                    </div>
                    <div id="auth-error" class="text-red-600 dark:text-red-400 text-sm hidden"></div>
                    <div class="flex flex-col gap-3 pt-2">
                        <button type="submit" class="w-full px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 font-semibold transition-colors">${buttonText}</button>
                        <button type="button" onclick="showAuthModal('${
                          mode === "login" ? "register" : "login"
                        }')" class="text-sm text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 transition-colors">${switchText}</button>
                    </div>
                </form>`;

        document.getElementById("auth-form").onsubmit = async (e) => {
          e.preventDefault();
          const errorDiv = document.getElementById("auth-error");
          errorDiv.classList.add("hidden");
          const email = document.getElementById("auth-email").value;
          const password = document.getElementById("auth-password").value;
          let result;
          if (mode === "register") {
            const name = document.getElementById("auth-name").value;
            result = await AuthManager.register(name, email, password);
          } else {
            result = await AuthManager.login(email, password);
          }
          if (result.success) {
            hideModal("form-modal");
            alert(result.message);
          } else {
            errorDiv.textContent = result.message;
            errorDiv.classList.remove("hidden");
          }
        };
        showModal("form-modal");
      }

      function closeAllItemMenus() {
        document.querySelectorAll('.item-menu').forEach(menu => menu.classList.add('hidden'));
      }

      function toggleItemMenu(event) {
          event.stopPropagation();
          const button = event.currentTarget;
          const menu = button.nextElementSibling;
          const isHidden = menu.classList.contains('hidden');
          // Close all other menus before opening a new one
          closeAllItemMenus();
          if (isHidden) {
              menu.classList.remove('hidden');
          }
      }

      function toggleSidebar(open) {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebar-overlay");
        const openBtn = document.getElementById("sidebar-toggle-open");
        if (open) {
          sidebar.classList.remove("-translate-x-full");
          overlay.classList.remove("hidden");
          openBtn.classList.add("opacity-0", "pointer-events-none");
          document.body.classList.add("overflow-hidden");
        } else {
          sidebar.classList.add("-translate-x-full");
          overlay.classList.add("hidden");
          openBtn.classList.remove("opacity-0", "pointer-events-none");
          document.body.classList.remove("overflow-hidden");
        }
      }

      function showModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
      }
      function hideModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
      }
      function hideAllModals() {
        modals.forEach(hideModal);
      }

      async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
        document.getElementById("gemini-modal-loader").style.display = "flex";
        document.getElementById("gemini-modal-text").innerHTML = "";
        try {
          const response = await fetch(`${API_BASE_URL}/gemini`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          const result = await response.json();
          const formattedText = result.text
            ? result.text
                .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                .replace(/\n/g, "<br>")
            : "N√£o foi poss√≠vel obter resposta.";
          document.getElementById("gemini-modal-loader").style.display = "none";
          document.getElementById("gemini-modal-text").innerHTML =
            formattedText;
        } catch (error) {
          if (retries > 0) {
            await new Promise((res) => setTimeout(res, delay));
            callGeminiAPI(prompt, retries - 1, delay * 2);
          } else {
            document.getElementById("gemini-modal-loader").style.display =
              "none";
            document.getElementById("gemini-modal-text").innerHTML =
              "Erro ao conectar.";
          }
        }
      }

      function getExplanation(topic, event) {
        event.stopPropagation();
        document.getElementById(
          "gemini-modal-title"
        ).textContent = `Explicando: ${topic}`;
        showModal("gemini-modal");
        callGeminiAPI(
          `Explique "${topic}" para desenvolvedor. Responda em portugu√™s do Brasil em 1-2 par√°grafos.`
        );
      }

      function getTopicsFromItems(items, topicList = []) {
        items.forEach((item) => {
          topicList.push(item.text);
          if (item.subItems) getTopicsFromItems(item.subItems, topicList);
        });
        return topicList;
      }

      function getProjectSuggestion(phaseIndex, event) {
        event.stopPropagation();
        const phase = roadmapData[phaseIndex];
        if (!phase) return;
        document.getElementById(
          "gemini-modal-title"
        ).textContent = `Projeto: ${phase.title}`;
        showModal("gemini-modal");
        const topics = getTopicsFromItems(phase.items).join(", ");
        callGeminiAPI(
          `Sugira mini-projeto para "${phase.title}" com: ${topics}. Portugu√™s do Brasil.`
        );
      }

      function findItemContextByPath(path) {
        const indices = path.split(",").map(Number);
        const phaseIndex = indices.shift();
        let parent = roadmapData[phaseIndex];
        let list = parent.items;
        const targetIndex = indices.pop();
        for (const index of indices) {
          parent = list[index];
          list = parent.subItems;
        }
        return { parent, list, item: list[targetIndex], index: targetIndex };
      }

      function moveItem(sourcePathStr, targetPathStr, position) {
        const { item: sourceItem } = findItemContextByPath(sourcePathStr);
        if (!sourceItem) return;
        const { list: targetList, index: targetIndex } =
          findItemContextByPath(targetPathStr);
        if (!targetList) return;
        let insertIndex = position === "before" ? targetIndex : targetIndex + 1;
        const { list: sourceList, index: sourceIndex } =
          findItemContextByPath(sourcePathStr);
        if (!sourceList) return;
        if (sourceList === targetList && sourceIndex < insertIndex)
          insertIndex--;
        sourceList.splice(sourceIndex, 1);
        targetList.splice(insertIndex, 0, sourceItem);
      }

      function showConfirmModal({ title, text, onConfirm }) {
        document.getElementById("confirm-modal-title").textContent = title;
        document.getElementById("confirm-modal-text").textContent = text;
        const confirmBtn = document.getElementById("confirm-modal-confirm");
        const cancelBtn = document.getElementById("confirm-modal-cancel");
        const confirmHandler = () => {
          onConfirm();
          hideModal("confirm-modal");
          cleanup();
        };
        const cancelHandler = () => {
          hideModal("confirm-modal");
          cleanup();
        };
        const cleanup = () => {
          confirmBtn.removeEventListener("click", confirmHandler);
          cancelBtn.removeEventListener("click", cancelHandler);
        };
        confirmBtn.addEventListener("click", confirmHandler);
        cancelBtn.addEventListener("click", cancelHandler);
        showModal("confirm-modal");
      }

      function showFormModal({ type, mode, path = "", phaseIndex = -1 }) {
        const isPhase = type === "phase";
        const isAdd = mode === "add";
        const title = `${isAdd ? "Adicionar" : "Editar"} ${
          isPhase ? "Fase" : "Item"
        }`;
        let currentData = {};
        if (!isAdd)
          currentData = isPhase
            ? roadmapData[parseInt(path)]
            : findItemContextByPath(path).item;

        document.getElementById("form-modal-title").textContent = title;
        document.getElementById("form-modal-content").innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="form-input-text" class="block text-sm font-medium text-slate-700 dark:text-slate-300">${
                          isPhase ? "T√≠tulo" : "Nome"
                        }</label>
                        <input type="text" id="form-input-text" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-md transition-colors outline-none focus:ring-2 focus:ring-teal-500" value="${
                          (isPhase ? currentData.title : currentData.text) || ""
                        }">
                    </div>
                    ${
                      isPhase
                        ? `<div>
                        <label for="form-input-desc" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Descri√ß√£o</label>
                        <textarea id="form-input-desc" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white rounded-md transition-colors outline-none focus:ring-2 focus:ring-teal-500">${
                          currentData.description || ""
                        }</textarea>
                    </div>`
                        : ""
                    }
                </div>
                <div class="flex justify-end mt-6">
                    <button id="form-save-btn" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">Salvar</button>
                </div>
            `;
        document.getElementById("form-save-btn").onclick = () => {
          const newText = document.getElementById("form-input-text").value;
          if (!newText.trim()) return;
          if (isPhase) {
            const newDesc = document.getElementById("form-input-desc").value;
            if (isAdd) {
              roadmapData.push({
                phase: String(roadmapData.length),
                title: newText,
                description: newDesc,
                items: [],
              });
            } else {
              roadmapData[parseInt(path)].title = newText;
              roadmapData[parseInt(path)].description = newDesc;
            }
          } else {
            if (isAdd) {
              const newItem = { text: newText, checked: false };
              if (path) {
                const { item } = findItemContextByPath(path);
                if (!item.subItems) item.subItems = [];
                item.subItems.push(newItem);
              } else {
                roadmapData[phaseIndex].items.push(newItem);
              }
            } else {
              findItemContextByPath(path).item.text = newText;
            }
          }
          renderApp();
          hideModal("form-modal");
        };
        showModal("form-modal");
      }

      function handleCrud(action, type, path = "", event) {
        if (event) event.stopPropagation();
        const isPhase = type === "phase";
        const phaseIndex = parseInt(path.split(",")[0]);
        if (action === "delete") {
          showConfirmModal({
            title: `Excluir ${isPhase ? "Fase" : "Item"}`,
            text: `Confirma exclus√£o?`,
            onConfirm: () => {
              if (isPhase) {
                roadmapData.splice(phaseIndex, 1);
                roadmapData.forEach((p, i) => (p.phase = String(i)));
              } else {
                const { list, index } = findItemContextByPath(path);
                list.splice(index, 1);
              }
              renderApp();
            },
          });
        } else {
          showFormModal({ type, mode: action, path });
        }
      }

      function toggleTask(path, event) {
        if (event) event.stopPropagation();
        const { item } = findItemContextByPath(path);
        if (item) {
          item.checked = !item.checked;
          renderApp();
        }
      }

      function renderApp() {
        hideAllModals();
        const sidebarNav = document.getElementById("sidebar-nav");
        const roadmapContent = document.getElementById("roadmap-content");
        sidebarNav.innerHTML = "";
        roadmapContent.innerHTML = "";
        if (overallChartInstance) overallChartInstance.destroy();
        if (phaseChartInstance) phaseChartInstance.destroy();

        let totalItems = 0,
          completedItems = 0;
        const phaseProgress = [];

        const countItems = (items) => {
          let counts = { total: 0, completed: 0 };
          items.forEach((item) => {
            counts.total++;
            if (item.checked) counts.completed++;
            if (item.subItems) {
              const subCounts = countItems(item.subItems);
              counts.total += subCounts.total;
              counts.completed += subCounts.completed;
            }
          });
          return counts;
        };

        const renderList = (items, pathPrefix) => {
          let html =
            '<ul class="space-y-1 mt-4 pl-4 border-l-2 border-slate-200 dark:border-slate-700 transition-colors duration-300">';
          items.forEach((item, index) => {
            const currentPath = `${pathPrefix},${index}`;
            const icon = item.checked ? "‚úÖ" : "‚¨úÔ∏è";
            html += `<li draggable="true" data-path="${currentPath}" class="text-slate-600 dark:text-slate-300 rounded-md p-2 hover:bg-slate-100 dark:hover:bg-slate-700/50 group transition-colors duration-200">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center cursor-pointer" onclick="toggleTask('${currentPath}', event)"><span class="mr-3">${icon}</span><span>${
              item.text
            }</span></span>
                            <div class="relative ml-auto">
                                <span class="action-icon hidden md:flex items-center gap-3 text-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="cursor-pointer" onclick="handleCrud('add', 'item', '${currentPath}', event)" title="Adicionar Subitem">‚ûï</span>
                                    <span class="cursor-pointer" onclick="handleCrud('edit', 'item', '${currentPath}', event)" title="Editar">‚úèÔ∏è</span>
                                    <span class="cursor-pointer" onclick="getExplanation('${item.text.replace(
                                  /'/g,
                                  "\\'"
                                )}', event)" title="Explicar com IA">‚ú®</span>
                                    <span class="cursor-pointer" onclick="handleCrud('delete', 'item', '${currentPath}', event)" title="Excluir">üóëÔ∏è</span>
                                </span>
                                <button class="md:hidden p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" onclick="toggleItemMenu(event)">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                                </button>
                                <div class="item-menu absolute right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 py-1 z-20 hidden">
                                    <a href="javascript:void(0)" onclick="handleCrud('add', 'item', '${currentPath}', event); closeAllItemMenus();" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">‚ûï Adicionar Subitem</a>
                                    <a href="javascript:void(0)" onclick="handleCrud('edit', 'item', '${currentPath}', event); closeAllItemMenus();" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">‚úèÔ∏è Editar</a>
                                    <a href="javascript:void(0)" onclick="getExplanation('${item.text.replace(
                                      /'/g,
                                      "\\'"
                                    )}', event); closeAllItemMenus();" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">‚ú® Explicar com IA</a>
                                    <div class="my-1 border-t border-slate-200 dark:border-slate-700"></div>
                                    <a href="javascript:void(0)" onclick="handleCrud('delete', 'item', '${currentPath}', event); closeAllItemMenus();" class="flex items-center gap-3 px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-slate-700">üóëÔ∏è Excluir</a>
                                </div>
                            </div>
                        </div>`;
            if (item.subItems) html += renderList(item.subItems, currentPath);
            html += `</li>`;
          });
          return html + "</ul>";
        };

        if (roadmapData.length === 0) {
          roadmapContent.innerHTML =
            '<div class="text-center p-12 bg-white dark:bg-slate-800 rounded-xl transition-colors duration-300"><h2 class="text-2xl font-semibold text-slate-800 dark:text-white">Roadmap Vazio</h2></div>';
        }

        roadmapData.forEach((phase, phaseIndex) => {
          const counts = countItems(phase.items);
          totalItems += counts.total;
          completedItems += counts.completed;
          phaseProgress.push({
            percentage:
              counts.total > 0 ? (counts.completed / counts.total) * 100 : 0,
          });

          const navLink = document.createElement("a");
          navLink.href = `#phase-${phase.phase}`;
          navLink.className =
            "flex items-start px-3 py-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md transition-colors duration-300";
          navLink.innerHTML = `<span class="w-8 h-8 flex-shrink-0 flex items-center justify-center font-bold text-teal-600 dark:text-teal-400 bg-teal-100 dark:bg-teal-900/30 rounded-full mr-3 transition-colors">${phase.phase}</span><span class="break-words pt-1">${phase.title}</span>`;
          navLink.onclick = () => {
            if (window.innerWidth < 768) toggleSidebar(false);
          };
          const li = document.createElement("li");
          li.draggable = true;
          li.dataset.phaseIndex = phaseIndex;
          li.appendChild(navLink);
          sidebarNav.appendChild(li);

          roadmapContent.innerHTML += `
                    <section id="phase-${phase.phase}" class="pt-4 scroll-mt-8">
                        <div class="bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-xl shadow-sm transition-colors duration-300">
                            <div class="flex justify-between items-center phase-header">
                                <h2 class="text-2xl font-semibold text-slate-800 dark:text-white transition-colors duration-300">${
                                  phase.title
                                }</h2>
                                <span class="action-icon flex items-center gap-4 text-xl">
                                    <span class="cursor-pointer" onclick="handleCrud('edit', 'phase', '${phaseIndex}', event)" title="Editar">‚úèÔ∏è</span>
                                    <span class="cursor-pointer" onclick="handleCrud('delete', 'phase', '${phaseIndex}', event)" title="Excluir">üóëÔ∏è</span>
                                </span>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-1 transition-colors duration-300">${
                              phase.description
                            }</p>
                            <div class="mt-4">
                               <button onclick="showFormModal({ type: 'item', mode: 'add', phaseIndex: ${phaseIndex} })" class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 text-sm font-medium transition-colors duration-300">Adicionar Item</button>
                               <button onclick="getProjectSuggestion(${phaseIndex}, event)" class="ml-2 inline-flex items-center gap-2 px-3 py-1.5 bg-teal-50 dark:bg-teal-900/20 text-teal-700 dark:text-teal-300 rounded-md hover:bg-teal-100 dark:hover:bg-teal-900/40 text-sm font-semibold transition-colors duration-300">Projeto ‚ú®</button>
                            </div>
                            ${renderList(phase.items, String(phaseIndex))}
                        </div>
                    </section>`;
        });

        const overallPercentage =
          totalItems > 0 ? ((completedItems / totalItems) * 100).toFixed(1) : 0;
        const isDark = ThemeManager.isDarkMode();
        document.getElementById(
          "stats"
        ).innerHTML = `<p id="stats-text" class="text-4xl font-bold ${
          isDark ? "text-white" : "text-slate-800"
        } transition-colors duration-300">${overallPercentage}%</p><p class="text-sm text-slate-500 dark:text-slate-400 transition-colors duration-300">${completedItems} de ${totalItems}</p>`;

        const overallCtx = document
          .getElementById("overallProgressChart")
          .getContext("2d");
        overallChartInstance = new Chart(overallCtx, {
          type: "doughnut",
          data: {
            labels: ["Conclu√≠do", "Pendente"],
            datasets: [
              {
                data: [completedItems, totalItems - completedItems],
                backgroundColor: ["#14b8a6", "#e2e8f0"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "68%",
            plugins: { legend: { display: window.innerWidth < 768 } },
          },
        });

        const phaseCtx = document
          .getElementById("phaseProgressChart")
          .getContext("2d");
        phaseChartInstance = new Chart(phaseCtx, {
          type: "bar",
          data: {
            labels: roadmapData.map((p) => `Fase ${p.phase}`),
            datasets: [
              {
                data: phaseProgress.map((p) => p.percentage),
                backgroundColor: "#5eead4",
                borderRadius: 4,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            scales: {
              x: { beginAtZero: true, max: 100, grid: { display: false } },
              y: { grid: { display: false } },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: (items) => roadmapData[items[0].dataIndex].title,
                  label: (ctx) => ` ${ctx.raw.toFixed(1)}%`,
                },
              },
            },
            onClick: (e, els) => {
              if (window.innerWidth >= 768 && els.length) {
                document
                  .getElementById(`phase-${roadmapData[els[0].index].phase}`)
                  .scrollIntoView({ behavior: "smooth" });
              }
            },
          },
        });
        ThemeManager.updateCharts(); 

        clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(
          () => AuthManager.saveRoadmapToServer(),
          2000
        );
      }

      document.addEventListener("DOMContentLoaded", async () => {
        ThemeManager.init();
        await AuthManager.init();
        renderApp();

        document
          .getElementById("sidebar-toggle-open")
          .addEventListener("click", () => toggleSidebar(true));
        document
          .getElementById("sidebar-toggle-close")
          .addEventListener("click", () => toggleSidebar(false));
        document
          .getElementById("sidebar-overlay")
          .addEventListener("click", () => toggleSidebar(false));

        const sidebarNavEl = document.getElementById("sidebar-nav");
        let draggedPhaseIndex = null;

        sidebarNavEl.addEventListener("dragstart", (e) => {
          const li = e.target.closest('li[draggable="true"]');
          if (li) {
            draggedPhaseIndex = parseInt(li.dataset.phaseIndex);
            setTimeout(() => li.classList.add("dragging"), 0);
          }
        });

        sidebarNavEl.addEventListener("dragend", (e) => {
          const li = e.target.closest('li[draggable="true"]');
          if (li) li.classList.remove("dragging");
          document
            .querySelectorAll(".drop-indicator")
            .forEach((el) => el.remove());
          draggedPhaseIndex = null;
        });

        sidebarNavEl.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dropTarget = e.target.closest('li[draggable="true"]');
          document
            .querySelectorAll(".drop-indicator")
            .forEach((el) => el.remove());

          if (!dropTarget || draggedPhaseIndex === null) return;

          const targetIndex = parseInt(dropTarget.dataset.phaseIndex);
          if (targetIndex === draggedPhaseIndex) return;

          const rect = dropTarget.getBoundingClientRect();
          const y = e.clientY - rect.top;

          const dropIndicator = document.createElement("div");
          dropIndicator.className = "drop-indicator";

          if (y < rect.height / 2) {
            dropTarget.before(dropIndicator);
            dropTarget.dataset.dropPosition = "before";
          } else {
            dropTarget.after(dropIndicator);
            dropTarget.dataset.dropPosition = "after";
          }
        });

        sidebarNavEl.addEventListener("drop", (e) => {
          e.preventDefault();
          const dropTarget = e.target.closest('li[draggable="true"]');
          if (!dropTarget || draggedPhaseIndex === null) return;

          const targetIndex = parseInt(dropTarget.dataset.phaseIndex);
          const dropPosition = dropTarget.dataset.dropPosition;

          if (draggedPhaseIndex !== targetIndex) {
            const phaseToMove = roadmapData[draggedPhaseIndex];
            let insertIndex =
              dropPosition === "before" ? targetIndex : targetIndex + 1;

            if (draggedPhaseIndex < insertIndex) {
              insertIndex--;
            }

            roadmapData.splice(draggedPhaseIndex, 1);
            roadmapData.splice(insertIndex, 0, phaseToMove);

            roadmapData.forEach((p, i) => (p.phase = String(i)));

            renderApp();
          }
        });

        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');

        if (userMenuButton) {
            userMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const isInvisible = userMenuDropdown.classList.contains('invisible');
                if (isInvisible) {
                    userMenuDropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
                    userMenuDropdown.classList.add('opacity-100', 'visible', 'scale-100');
                } else {
                    userMenuDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                    userMenuDropdown.classList.remove('opacity-100', 'visible', 'scale-100');
                }
            });
        }

        document.addEventListener('click', (event) => {
            const itemMenuButton = event.target.closest('[onclick="toggleItemMenu(event)"]');
            if (!itemMenuButton) {
                closeAllItemMenus();
            }
            if (userMenuButton && userMenuDropdown && !userMenuDropdown.classList.contains('invisible')) {
                if (!userMenuButton.contains(event.target) && !userMenuDropdown.contains(event.target)) {
                    userMenuDropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                    userMenuDropdown.classList.remove('opacity-100', 'visible', 'scale-100');
                }
            }
        });

        const sidebar = document.getElementById("sidebar");
        const resizer = document.getElementById("resizer");
        const mainContent = document.getElementById("main-content");
        const minWidth = 200;
        const maxWidth = 500;

        function setMainContentMargin() {
          const isMobile = window.innerWidth < 768;
          if (isMobile) {
            mainContent.style.marginLeft = "0px";
          } else {
            mainContent.style.marginLeft = sidebar.style.width;
            resizer.style.left = sidebar.style.width;
          }

          if (overallChartInstance) {
            if (overallChartInstance.options.plugins.legend.display !== isMobile) {
                overallChartInstance.options.plugins.legend.display = isMobile;
                overallChartInstance.update();
            }
          }
        }

        setMainContentMargin();
        window.addEventListener("resize", setMainContentMargin);

        resizer.addEventListener("mousedown", (e) => {
          e.preventDefault();
          document.body.classList.add("resizing");
          const mouseMoveHandler = (moveEvent) => {
            let newWidth = moveEvent.clientX;
            if (newWidth < minWidth) newWidth = minWidth;
            if (newWidth > maxWidth) newWidth = maxWidth;
            sidebar.style.width = `${newWidth}px`;
            setMainContentMargin();
          };
          const mouseUpHandler = () => {
            document.body.classList.remove("resizing");
            window.removeEventListener("mousemove", mouseMoveHandler);
            window.removeEventListener("mouseup", mouseUpHandler);
            if (overallChartInstance) overallChartInstance.resize();
            if (phaseChartInstance) phaseChartInstance.resize();
          };
          window.addEventListener("mousemove", mouseMoveHandler);
          window.addEventListener("mouseup", mouseUpHandler);
        });

        const roadmapContentEl = document.getElementById("roadmap-content");
        let draggedPath = null;

        roadmapContentEl.addEventListener("dragstart", (e) => {
          const li = e.target.closest('li[draggable="true"]');
          if (li) {
            draggedPath = li.dataset.path;
            setTimeout(() => li.classList.add("dragging"), 0);
          }
        });

        roadmapContentEl.addEventListener("dragend", (e) => {
          const li = e.target.closest('li[draggable="true"]');
          if (li) li.classList.remove("dragging");
          document
            .querySelectorAll(".drop-indicator")
            .forEach((el) => el.remove());
          draggedPath = null;
        });

        roadmapContentEl.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dropTarget = e.target.closest('li[draggable="true"]');
          document
            .querySelectorAll(".drop-indicator")
            .forEach((el) => el.remove());
          if (
            !dropTarget ||
            !draggedPath ||
            dropTarget.dataset.path === draggedPath ||
            (dropTarget.dataset.path &&
              dropTarget.dataset.path.startsWith(draggedPath + ","))
          )
            return;
          const rect = dropTarget.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const dropIndicator = document.createElement("div");
          dropIndicator.className = "drop-indicator";
          if (y < rect.height / 2) {
            dropTarget.before(dropIndicator);
            dropTarget.dataset.dropPosition = "before";
          } else {
            dropTarget.after(dropIndicator);
            dropTarget.dataset.dropPosition = "after";
          }
        });

        roadmapContentEl.addEventListener("drop", (e) => {
          e.preventDefault();
          const dropTarget = e.target.closest('li[draggable="true"]');
          if (!dropTarget || !draggedPath) return;
          const targetPath = dropTarget.dataset.path;
          const dropPosition = dropTarget.dataset.dropPosition;
          if (
            targetPath &&
            draggedPath !== targetPath &&
            !targetPath.startsWith(draggedPath + ",")
          ) {
            moveItem(draggedPath, targetPath, dropPosition);
            renderApp();
          }
        });

        window.addEventListener("scroll", () => {
          let current = "";
          const sections = document.querySelectorAll(
            "#roadmap-content section"
          );
          const isAtBottom =
            window.innerHeight + window.scrollY >=
            document.documentElement.scrollHeight - 2;
          if (isAtBottom && sections.length > 0) {
            current = sections[sections.length - 1].getAttribute("id");
          } else {
            sections.forEach((section) => {
              if (window.pageYOffset >= section.offsetTop - 80) {
                current = section.getAttribute("id");
              }
            });
          }

          document.querySelectorAll("#sidebar-nav a").forEach((link) => {
            const isActive = link.getAttribute("href").substring(1) === current;
            const isDark = ThemeManager.isDarkMode();
            link.classList.toggle("bg-teal-50", isActive && !isDark);
            link.classList.toggle("text-teal-700", isActive && !isDark);
            link.classList.toggle("bg-teal-900/30", isActive && isDark);
            link.classList.toggle("text-teal-300", isActive && isDark);
          });
        });

        document.addEventListener("keydown", (e) => {
          if (e.key !== "Enter" || e.shiftKey) return;
          const confirmModal = document.getElementById("confirm-modal");
          if (!confirmModal.classList.contains("hidden")) {
            e.preventDefault();
            document.getElementById("confirm-modal-confirm").click();
            return;
          }
          const formModal = document.getElementById("form-modal");
          if (!formModal.classList.contains("hidden")) {
            if (document.activeElement.tagName === "TEXTAREA") return;
            e.preventDefault();
            const saveBtn = document.getElementById("form-save-btn");
            const authBtn = formModal.querySelector(
              '#auth-form button[type="submit"]'
            );
            if (saveBtn) saveBtn.click();
            else if (authBtn) authBtn.click();
          }
        });
      });
    </script>
  </body>
</html>
