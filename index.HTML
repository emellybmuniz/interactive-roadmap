<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadmap Customiz√°vel Full-Stack com IA ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 280px;
            width: 100%;
            max-width: 280px;
        }
        .bar-chart-container {
            position: relative;
            margin: auto;
            height: 320px;
            width: 100%;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* slate-200 */
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        .modal-header-button {
            font-size: 2rem;
            line-height: 1;
            font-weight: 600;
        }
        .action-icon {
            opacity: 0;
            transition: opacity 0.2s;
        }
        li:hover .action-icon {
            opacity: 1;
        }
        .phase-header .action-icon {
            opacity: 1;
        }
        .drop-indicator {
            height: 4px;
            background-color: #2dd4bf; 
            border-radius: 2px;
            margin: -2px 0;
        }
        li.dragging {
            opacity: 0.4;
        }
        body.resizing, body.resizing * {
            cursor: col-resize !important;
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="text-slate-700">

    <!-- Sidebar Toggle Button (Mobile) -->
    <button id="sidebar-toggle-open" class="md:hidden fixed top-4 left-4 z-30 bg-white/80 backdrop-blur-sm p-2 rounded-md shadow-lg text-slate-600 hover:text-slate-900 transition-opacity">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="bg-white border-r border-slate-200 p-6 fixed top-0 left-0 h-full flex flex-col transition-transform duration-300 ease-in-out z-40 -translate-x-full md:translate-x-0" style="width: 333px;">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-bold text-slate-800">Fases do Roadmap</h1>
                <button id="sidebar-toggle-close" class="md:hidden text-slate-500 hover:text-slate-800 transition-colors text-3xl leading-none">&times;</button>
            </div>
            <nav class="flex-grow overflow-y-auto">
                <ul id="sidebar-nav" class="space-y-2">
                    <!-- Navigation links will be injected here -->
                </ul>
            </nav>
            <div class="mt-6 flex-shrink-0">
                <button onclick="showFormModal({ type: 'phase', mode: 'add' })" class="w-full px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors font-semibold">Adicionar Fase</button>
                <div id="auth-section" class="mt-2 text-center">
                </div>
            </div>
        </aside>

        <!-- Resizer Handle -->
        <div id="resizer" class="w-1.5 cursor-col-resize bg-slate-200/50 hover:bg-teal-400 transition-colors duration-200 fixed top-0 h-full z-20 hidden md:block" style="left: 328px;"></div>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 sm:p-6 md:p-8 transition-all duration-300 ease-in-out">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-slate-900 mb-2">Roadmap de Desenvolvimento Full-Stack</h1>
                <p class="text-lg text-slate-500">Uma jornada visual e interativa, com o poder da IA ‚ú® integrada para acelerar seu aprendizado.</p>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="mb-12">
                <h2 class="text-2xl font-semibold text-slate-800 mb-4 border-b pb-2">Painel de Progresso üéØ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="font-semibold text-center mb-4">Progresso Geral</h3>
                        <div class="chart-container">
                            <canvas id="overallProgressChart"></canvas>
                        </div>
                        <div id="stats" class="text-center mt-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm xl:col-span-2">
                        <h3 class="font-semibold text-left mb-4">Progresso por Fase</h3>
                        <div class="bar-chart-container">
                             <canvas id="phaseProgressChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <div id="roadmap-content" class="space-y-12"></div>
        </main>
    </div>
    
    <!-- Modals -->
    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" class="md:hidden fixed inset-0 bg-black/50 z-30 hidden"></div>

    <div id="gemini-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"><header class="p-4 border-b border-slate-200 flex justify-between items-center flex-shrink-0"><h3 id="gemini-modal-title" class="text-lg font-semibold text-slate-800"></h3><button onclick="hideModal('gemini-modal')" class="text-slate-400 hover:text-slate-800 transition-colors modal-header-button">&times;</button></header><div class="p-6 overflow-y-auto"><div id="gemini-modal-loader" class="flex justify-center items-center h-48"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-teal-500"></div></div><div id="gemini-modal-text" class="text-slate-600 leading-relaxed space-y-4"></div></div></div></div>
    <div id="form-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg"><header class="p-4 border-b border-slate-200 flex justify-between items-center"><h3 id="form-modal-title" class="text-lg font-semibold text-slate-800"></h3><button onclick="hideModal('form-modal')" class="text-slate-400 hover:text-slate-800 transition-colors modal-header-button">&times;</button></header><div id="form-modal-content" class="p-6"></div></div></div>
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><header class="p-4 flex justify-between items-center"><h3 id="confirm-modal-title" class="text-lg font-semibold text-red-600"></h3><button onclick="hideModal('confirm-modal')" class="text-slate-400 hover:text-slate-800 transition-colors modal-header-button">&times;</button></header><div class="p-6 pt-0"><p id="confirm-modal-text" class="text-slate-600 mb-6"></p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button><button id="confirm-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar</button></div></div></div></div>
    <div id="auth-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><header class="p-4 border-b border-slate-200 flex justify-between items-center"><h3 id="auth-modal-title" class="text-lg font-semibold text-slate-800"></h3><button onclick="hideModal('auth-modal')" class="text-slate-400 hover:text-slate-800 transition-colors modal-header-button">&times;</button></header><div id="auth-modal-content" class="p-6"></div></div></div>

    <script>
        let initialRoadmapData = [
            {
                phase: "0",
                title: "Fundamentos",
                description: "A base para qualquer desenvolvedor de software moderno, cobrindo versionamento, linha de comando e protocolos essenciais.",
                items: [
                    { text: "Git & GitHub", checked: true },
                    { text: "Linha de Comando (CLI)", checked: true },
                    { text: "HTTP/HTTPS", checked: true },
                    { text: "JSON", checked: true },
                    { text: "Cloud (Conceitos b√°sicos)", checked: true },
                    { text: "SQL (Fundamentos)", checked: true },
                    {
                        text: "Gerenciamento de Pacotes e Ambientes",
                        checked: false,
                        subItems: [
                            { text: "npm / Yarn / pnpm (JavaScript)", checked: false },
                            { text: "venv (Python)", checked: true },
                            { text: "Maven / Gradle (Java)", checked: true }
                        ]
                    }
                ]
            },
            {
                phase: "1",
                title: "Desenvolvimento Front-End",
                description: "Construindo a parte visual e interativa das aplica√ß√µes web, desde a estrutura b√°sica at√© frameworks modernos.",
                items: [
                    { text: "HTML", checked: true },
                    {
                        text: "CSS",
                        checked: true,
                        subItems: [
                            { text: "Bootstrap", checked: false },
                            { text: "Tailwind CSS", checked: false },
                            { text: "Sass", checked: false },
                            { text: "Styled-components", checked: false }
                        ]
                    },
                    {
                        text: "JavaScript",
                        checked: false,
                        subItems: [
                            { text: "Fundamentos (Tipos, Vari√°veis, Fun√ß√µes, etc.)", checked: true },
                            { text: "Manipula√ß√£o do DOM", checked: true },
                            { text: "Assincronicidade (Promises, Async/Await)", checked: false },
                            { text: "Modulariza√ß√£o (ES Modules)", checked: false },
                            { text: "Armazenamento (LocalStorage)", checked: true },
                            { text: "Tratamento de Erros", checked: true },
                            { text: "Conceitos de Acessibilidade", checked: true }
                        ]
                    },
                    { text: "TypeScript", checked: false },
                    {
                        text: "React.js",
                        checked: false,
                        subItems: [
                            { text: "React Router", checked: false },
                            { text: "React Hook Form", checked: false },
                            { text: "React Query", checked: false }
                        ]
                    },
                    { text: "Gerenciamento de Estado", checked: false, subItems: [{ text: "Redux Toolkit", checked: false }, { text: "Zustand", checked: false }] },
                    { text: "Next.js", checked: false },
                    { text: "Ferramentas de Build", checked: false, subItems: [{ text: "Vite", checked: false }, { text: "Webpack", checked: false }] }
                ]
            },
            {
                phase: "2",
                title: "Desenvolvimento Back-End (Ecossistema JavaScript)",
                description: "Criando a l√≥gica do servidor, APIs e gerenciando dados com Node.js e seus frameworks.",
                items: [
                    { text: "Node.js", checked: false },
                    { text: "Express.js", checked: false },
                    { text: "Nest.js", checked: false },
                    { text: "APIs e Protocolos", checked: false, subItems: [{ text: "REST", checked: false }, { text: "GraphQL", checked: false, subItems: [{ text: "Apollo", checked: false }] }] },
                    { text: "Autentica√ß√£o & Seguran√ßa", checked: false, subItems: [{ text: "JSON Web Tokens (JWT)", checked: false }] },
                    { text: "Comunica√ß√£o em Tempo Real", checked: false, subItems: [{ text: "WebSockets", checked: false }] }
                ]
            },
            {
                phase: "3",
                title: "Bancos de Dados",
                description: "Gerenciando e persistindo dados com bancos de dados relacionais (SQL) e n√£o-relacionais (NoSQL).",
                items: [
                    {
                        text: "SQL (Bancos de Dados Relacionais)",
                        checked: false,
                        subItems: [
                            { text: "Linguagem SQL", checked: true },
                            { text: "MySQL", checked: true },
                            { text: "PostgreSQL", checked: false },
                            { text: "Sequelize (ORM)", checked: false },
                            { text: "Prisma (ORM)", checked: false }
                        ]
                    },
                    {
                        text: "NoSQL (Bancos de Dados N√£o-Relacionais)",
                        checked: false,
                        subItems: [
                            { text: "MongoDB", checked: false },
                            { text: "Mongoose (ODM)", checked: false }
                        ]
                    }
                ]
            },
            {
                phase: "4",
                title: "Testes e Qualidade de C√≥digo",
                description: "Garantindo a robustez e a manutenibilidade do software atrav√©s de testes automatizados e ferramentas de qualidade.",
                items: [
                    { text: "Jest", checked: false },
                    { text: "Cypress", checked: false },
                    { text: "ESLint", checked: false },
                    { text: "Prettier", checked: true }
                ]
            },
            {
                phase: "5",
                title: "Arquitetura e Boas Pr√°ticas",
                description: "Aprendendo princ√≠pios e padr√µes para construir software escal√°vel, manuten√≠vel e de alta qualidade.",
                items: [
                    { text: "SOLID", checked: true },
                    { text: "Seguran√ßa Web (OWASP Top 10)", checked: false },
                    { text: "Clean Architecture", checked: false },
                    { text: "Design Patterns", checked: false },
                    { text: "Domain-Driven Design (DDD)", checked: false },
                    { text: "Arquitetura de Microsservi√ßos", checked: false }
                ]
            },
            {
                phase: "6",
                title: "Infraestrutura e Implanta√ß√£o (DevOps)",
                description: "Automatizando a entrega de software e gerenciando a infraestrutura como c√≥digo.",
                items: [
                    {
                        text: "Containers",
                        checked: false,
                        subItems: [
                            { text: "Docker", checked: false },
                            { text: "Kubernetes", checked: false },
                            { text: "Container Registry (Docker Hub, GitHub Packages)", checked: false }
                        ]
                    },
                    { text: "CI/CD (Integra√ß√£o e Entrega Cont√≠nua)", checked: false, subItems: [{ text: "GitHub Actions", checked: false }] },
                    {
                        text: "Computa√ß√£o em Nuvem",
                        checked: false,
                        subItems: [{ text: "Fundamentos (IaaS, PaaS, SaaS)", checked: true }, { text: "AWS", checked: true }, { text: "Azure", checked: true }, { text: "Google Cloud", checked: true }]
                    },
                    { text: "Mensageria e Filas", checked: false, subItems: [{ text: "Kafka", checked: false }] }
                ]
            }
        ];
        let roadmapData = initialRoadmapData;

        // Global variables for UI and state
        const modals = ['gemini-modal', 'form-modal', 'confirm-modal', 'auth-modal'];
        let overallChartInstance = null;
        let phaseChartInstance = null;

        // --- Sidebar Management ---
        function toggleSidebar(open) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const openBtn = document.getElementById('sidebar-toggle-open');

            if (open) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                openBtn.classList.add('opacity-0', 'pointer-events-none');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                openBtn.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        // --- Modal Management ---
        function showModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function hideModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        function hideAllModals() { modals.forEach(hideModal); }

        // --- Gemini API ---
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            document.getElementById('gemini-modal-loader').style.display = 'flex';
            document.getElementById('gemini-modal-text').innerHTML = '';

            const apiUrl = '/api/gemini'; 
            try {
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ prompt: prompt }) 
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} - ${await response.text()}`);
                const result = await response.json();
                const text = result.text;
                const formattedText = text ? text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-800">$1</strong>').replace(/\n/g, '<br>') : "N√£o foi poss√≠vel obter uma resposta.";
                document.getElementById('gemini-modal-loader').style.display = 'none';
                document.getElementById('gemini-modal-text').innerHTML = formattedText;
            } catch (error) {
                if (retries > 0) { await new Promise(res => setTimeout(res, delay)); callGeminiAPI(prompt, retries - 1, delay * 2); } 
                else { 
                    document.getElementById('gemini-modal-loader').style.display = 'none';
                    document.getElementById('gemini-modal-text').innerHTML = `Desculpe, n√£o conseguimos conectar ao servidor no momento. Por favor, verifique sua conex√£o e tente novamente mais tarde.`; 
                }; 
                }
            }
            
        function getExplanation(topic, event) {
            event.stopPropagation();
            document.getElementById('gemini-modal-title').textContent = `Explicando: ${topic}`;
            showModal('gemini-modal');
            const prompt = `Explique o que √© "${topic}" para um desenvolvedor de software. Foque nos conceitos chave. Responda em portugu√™s do Brasil em um ou dois par√°grafos.`;
            callGeminiAPI(prompt);
        }
        function getTopicsFromItems(items, topicList = []) {
            items.forEach(item => { topicList.push(item.text); if (item.subItems) getTopicsFromItems(item.subItems, topicList); });
            return topicList;
        }
        function getProjectSuggestion(phaseIndex, event) {
            event.stopPropagation();
            const phase = roadmapData[phaseIndex];
            if (!phase) return;
            document.getElementById('gemini-modal-title').textContent = `Sugerindo projeto para: ${phase.title}`;
            showModal('gemini-modal');
            const topicsList = getTopicsFromItems(phase.items).join(', ');
            const prompt = `Sugira um mini-projeto para um desenvolvedor que est√° estudando "${phase.title}" e os t√≥picos: ${topicsList}. Descreva o projeto, suas funcionalidades e tecnologias. Responda em portugu√™s do Brasil.`;
            callGeminiAPI(prompt);
        }

        // --- Auth and Data Persistence ---
        function showAuthModal(mode) {
            const isLogin = mode === 'login';
            document.getElementById('auth-modal-title').textContent = isLogin ? 'Entrar' : 'Criar Conta';
            const formContent = document.getElementById('auth-modal-content');
            formContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-slate-700">Email</label>
                        <input type="email" id="auth-email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-slate-700">Senha</label>
                        <input type="password" id="auth-password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" required>
                    </div>
                    <p id="auth-error" class="text-red-500 text-sm hidden"></p>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="auth-submit-btn" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600">${isLogin ? 'Entrar' : 'Criar Conta'}</button>
                </div>
            `;

            document.getElementById('auth-submit-btn').onclick = async () => {
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const errorEl = document.getElementById('auth-error');
                errorEl.classList.add('hidden');

                try {
                    const response = await fetch(`/api/${mode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || 'Ocorreu um erro.');
                    }

                    if (isLogin) {
                        localStorage.setItem('authToken', data.token);
                        if (data.roadmapData && data.roadmapData.length > 0) {
                            roadmapData = data.roadmapData;
                        } else {
                            roadmapData = JSON.parse(JSON.stringify(initialRoadmapData)); // Reset to a clean copy
                        }
                        hideModal('auth-modal');
                        renderApp();
                    } else {
                        hideModal('auth-modal');
                        alert('Conta criada com sucesso! Agora voc√™ pode entrar.');
                        showAuthModal('login');
                    }
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                }
            };

            showModal('auth-modal');
        }

        function logout() {
            localStorage.removeItem('authToken');
            roadmapData = JSON.parse(JSON.stringify(initialRoadmapData)); // Volta para os dados iniciais
            renderApp();
        }

        async function saveProgress() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Voc√™ precisa estar logado para salvar seu progresso.');
                showAuthModal('login');
                return;
            }

            try {
                const response = await fetch('/api/roadmap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ roadmapData })
                });
                if (!response.ok) throw new Error('N√£o foi poss√≠vel salvar.');
                alert('Progresso salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao Salvar Configura√ß√£o:', error);
                alert('Erro ao salvar o progresso. Tente novamente.');
            }
        }

        function renderAuthSection() {
            const authSection = document.getElementById('auth-section');
            const token = localStorage.getItem('authToken');
            if (token) {
                authSection.innerHTML = `
                    <button onclick="saveProgress()" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">Salvar Configura√ß√£o</button>
                    <button onclick="logout()" class="mt-2 text-sm text-slate-500 hover:text-slate-800">Sair</button>
                `;
            } else {
                authSection.innerHTML = `
                    <button onclick="showAuthModal('login')" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">Salvar Configura√ß√£o</button>
                    <a href="#" onclick="event.preventDefault(); showAuthModal('register')" class="mt-2 text-sm text-slate-500 hover:text-slate-800">Criar conta</a>
                `;
            }
        }

        // --- CRUD and State Management ---
        function findItemContextByPath(path) {
            const indices = path.split(',').map(Number);
            const phaseIndex = indices.shift();
            
            let parent = roadmapData[phaseIndex];
            let list = parent.items;
            
            const targetIndex = indices.pop();
            
            // Traverse to the parent list
            for (const index of indices) {
                parent = list[index];
                list = parent.subItems;
            }
            
            const item = list[targetIndex];
            
            return { parent, list, item, index: targetIndex };
        }

        function moveItem(sourcePathStr, targetPathStr, position) {
            const { item: sourceItem } = findItemContextByPath(sourcePathStr);
            if (!sourceItem) return;

            const { list: targetList, index: targetIndex } = findItemContextByPath(targetPathStr);
            if (!targetList) return;

            // Calculate insertion index
            let insertIndex = position === 'before' ? targetIndex : targetIndex + 1;

            const { list: sourceList, index: sourceIndex } = findItemContextByPath(sourcePathStr);
            if (!sourceList) return;

            if (sourceList === targetList && sourceIndex < insertIndex) {
                insertIndex--;
            }

            sourceList.splice(sourceIndex, 1);
            targetList.splice(insertIndex, 0, sourceItem);
        }

        function showConfirmModal({ title, text, onConfirm }) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            
            const confirmHandler = () => {
                onConfirm();
                hideModal('confirm-modal');
                cleanup();
            };
            const cancelHandler = () => {
                hideModal('confirm-modal');
                cleanup();
            };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            showModal('confirm-modal');
        }

        function showFormModal({ type, mode, path = '', phaseIndex = -1 }) {
            const isPhase = type === 'phase';
            const isAdd = mode === 'add';
            const title = `${isAdd ? 'Adicionar' : 'Editar'} ${isPhase ? 'Fase' : 'Item'}`;
            let currentData = {};

            if (!isAdd) {
                if (isPhase) {
                    currentData = roadmapData[parseInt(path)];
                } else {
                    currentData = findItemContextByPath(path).item;
                }
            }

            document.getElementById('form-modal-title').textContent = title;
            const formContent = document.getElementById('form-modal-content');
            
            formContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="form-input-text" class="block text-sm font-medium text-slate-700">${isPhase ? 'T√≠tulo da Fase' : 'Nome do Item'}</label>
                        <input type="text" id="form-input-text" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm" value="${(isPhase ? currentData.title : currentData.text) || ''}">
                    </div>
                    ${isPhase ? `<div>
                        <label for="form-input-desc" class="block text-sm font-medium text-slate-700">Descri√ß√£o</label>
                        <textarea id="form-input-desc" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">${currentData.description || ''}</textarea>
                    </div>` : ''}
                </div>
                <div class="flex justify-end mt-6">
                    <button id="form-save-btn" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600">Salvar</button>
                </div>
            `;
            
            document.getElementById('form-save-btn').onclick = () => {
                const newText = document.getElementById('form-input-text').value;
                if (!newText.trim()) return;

                if (isPhase) {
                    const newDesc = document.getElementById('form-input-desc').value;
                    if (isAdd) {
                        roadmapData.push({ phase: String(roadmapData.length), title: newText, description: newDesc, items: [] });
                    } else {
                        roadmapData[parseInt(path)].title = newText;
                        roadmapData[parseInt(path)].description = newDesc;
                    }
                } else {
                    if (isAdd) {
                        const newItem = { text: newText, checked: false };
                        if (path) {
                            const { item } = findItemContextByPath(path);
                            if (!item.subItems) item.subItems = [];
                            item.subItems.push(newItem);
                        } else {
                            roadmapData[phaseIndex].items.push(newItem);
                        }
                    } else {
                        findItemContextByPath(path).item.text = newText;
                    }
                }
                renderApp();
                hideModal('form-modal');
            };

            showModal('form-modal');
        }
        
        function handleCrud(action, type, path = '', event) {
            if (event) event.stopPropagation();
            const isPhase = type === 'phase';
            const phaseIndex = parseInt(path.split(',')[0]);

            if (action === 'delete') {
                const title = `Excluir ${isPhase ? 'Fase' : 'Item'}`;
                const text = `Voc√™ tem certeza? Esta a√ß√£o ${isPhase ? 'excluir√° a fase e todos os seus itens e' : ''} n√£o pode ser desfeita.`;
                showConfirmModal({ title, text, onConfirm: () => {
                    if (isPhase) {
                        roadmapData.splice(phaseIndex, 1);
                        roadmapData.forEach((p, i) => p.phase = String(i)); 
                    } else {
                        const { list, index } = findItemContextByPath(path);
                        list.splice(index, 1);
                    }
                    renderApp();
                }});
            } else { 
                showFormModal({ type, mode: action, path });
            }
        }
        
        function toggleTask(path, event) {
            if (event) event.stopPropagation();
            const { item } = findItemContextByPath(path);
            if (item) {
                item.checked = !item.checked;
                renderApp();
            }
        }

        function renderApp() {
            hideAllModals();
            const sidebarNav = document.getElementById('sidebar-nav');
            const roadmapContent = document.getElementById('roadmap-content');
            sidebarNav.innerHTML = '';
            roadmapContent.innerHTML = '';
            if (overallChartInstance) overallChartInstance.destroy();
            if (phaseChartInstance) phaseChartInstance.destroy();

            let totalItems = 0, completedItems = 0;
            renderAuthSection();
            const phaseProgress = [];

            const countItems = (items) => {
                let counts = { total: 0, completed: 0 };
                items.forEach(item => {
                    counts.total++;
                    if (item.checked) counts.completed++;
                    if (item.subItems) {
                        const subCounts = countItems(item.subItems);
                        counts.total += subCounts.total;
                        counts.completed += subCounts.completed;
                    }
                });
                return counts;
            };
            
            const renderList = (items, pathPrefix) => {
                let html = '<ul class="space-y-1 mt-4 pl-4 border-l-2 border-slate-200">';
                items.forEach((item, index) => {
                    const currentPath = `${pathPrefix},${index}`;
                    const icon = item.checked ? '‚úÖ' : '‚¨úÔ∏è';
                    html += `<li draggable="true" data-path="${currentPath}" class="text-slate-600 rounded-md p-2 hover:bg-slate-100 group cursor-pointer">
                        <div class="flex items-center justify-between">
                            <span class="flex items-center cursor-pointer" onclick="toggleTask('${currentPath}', event)"><span class="mr-3">${icon}</span><span>${item.text}</span></span>
                            <span class="action-icon flex items-center gap-3 text-lg">
                                <span onclick="handleCrud('add', 'item', '${currentPath}', event)" title="Adicionar Sub-item">‚ûï</span>
                                <span onclick="handleCrud('edit', 'item', '${currentPath}', event)" title="Editar Item">‚úèÔ∏è</span>
                                <span onclick="getExplanation('${item.text.replace(/'/g, "\\'")}', event)" title="Explicar com IA">‚ú®</span>
                                <span onclick="handleCrud('delete', 'item', '${currentPath}', event)" title="Excluir Item">üóëÔ∏è</span>
                            </span>
                        </div>`;
                    if (item.subItems) html += renderList(item.subItems, currentPath);
                    html += `</li>`;
                });
                return html + '</ul>';
            };

            if (roadmapData.length === 0) {
                roadmapContent.innerHTML = `<div class="text-center p-12 bg-white rounded-xl shadow-sm"><h2 class="text-2xl font-semibold text-slate-800">Roadmap Vazio!</h2><p class="text-slate-500 mt-2">Comece adicionando uma nova fase usando o bot√£o na barra lateral.</p></div>`;
            }

            roadmapData.forEach((phase, phaseIndex) => {
                const counts = countItems(phase.items);
                totalItems += counts.total;
                completedItems += counts.completed;
                phaseProgress.push({ percentage: counts.total > 0 ? (counts.completed / counts.total) * 100 : 0 });

                const navLink = document.createElement('a');
                navLink.href = `#phase-${phase.phase}`;
                navLink.className = "flex items-start px-3 py-2 text-slate-600 hover:bg-slate-100 rounded-md";
                navLink.innerHTML = `<span class="w-8 h-8 flex-shrink-0 flex items-center justify-center font-bold text-teal-600 bg-teal-100 rounded-full mr-3">${phase.phase}</span><span class="break-words pt-1">${phase.title}</span>`;
                navLink.onclick = () => { if (window.innerWidth < 768) toggleSidebar(false); };
                const li = document.createElement('li');
                li.appendChild(navLink);
                sidebarNav.appendChild(li);
                
                roadmapContent.innerHTML += `
                    <section id="phase-${phase.phase}" class="pt-4">
                        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm">
                            <div class="flex justify-between items-center phase-header">
                                <h2 class="text-2xl font-semibold text-slate-800">${phase.title}</h2>
                                <span class="action-icon flex items-center gap-4 text-xl">
                                    <span onclick="handleCrud('edit', 'phase', '${phaseIndex}', event)" title="Editar Fase">‚úèÔ∏è</span>
                                    <span onclick="handleCrud('delete', 'phase', '${phaseIndex}', event)" title="Excluir Fase">üóëÔ∏è</span>
                                </span>
                            </div>
                            <p class="text-slate-500 mt-1">${phase.description}</p>
                            <div class="mt-4">
                               <button onclick="showFormModal({ type: 'item', mode: 'add', phaseIndex: ${phaseIndex} })" class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200 text-sm font-medium">Adicionar Item</button>
                               <button onclick="getProjectSuggestion(${phaseIndex}, event)" class="ml-2 inline-flex items-center gap-2 px-3 py-1.5 bg-teal-50 text-teal-700 rounded-md hover:bg-teal-100 text-sm font-semibold">Sugerir Projeto ‚ú®</button>
                            </div>
                            ${renderList(phase.items, String(phaseIndex))}
                        </div>
                    </section>`;
            });
            
            const overallPercentage = totalItems > 0 ? (completedItems / totalItems * 100).toFixed(1) : 0;
            document.getElementById('stats').innerHTML = `<p class="text-4xl font-bold text-slate-800">${overallPercentage}%</p><p class="text-sm text-slate-500">${completedItems} de ${totalItems} itens conclu√≠dos</p>`;

            const overallCtx = document.getElementById('overallProgressChart').getContext('2d');
            overallChartInstance = new Chart(overallCtx, { type: 'doughnut', data: { labels: ['Conclu√≠do', 'Pendente'], datasets: [{ data: [completedItems, totalItems - completedItems], backgroundColor: ['#14b8a6', '#e2e8f0'], borderColor: ['#f8fafc'], borderWidth: 1}] }, options: { responsive: true, maintainAspectRatio: false, cutout: '68%', plugins: { legend: { display: false } } } });

            const phaseCtx = document.getElementById('phaseProgressChart').getContext('2d');
            phaseChartInstance = new Chart(phaseCtx, { type: 'bar', data: { labels: roadmapData.map(p => `Fase ${p.phase}`), datasets: [{ label: 'Progresso (%)', data: phaseProgress.map(p => p.percentage), backgroundColor: '#5eead4', borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 100 }}, plugins: { legend: { display: false }, tooltip: { callbacks: { title: (items) => roadmapData[items[0].dataIndex].title, label: (ctx) => ` Progresso: ${ctx.raw.toFixed(1)}%` }}}, onClick: (e, els) => { if(els.length) document.getElementById(`phase-${roadmapData[els[0].index].phase}`).scrollIntoView({ behavior: 'smooth' }); } } });
        }
        
        async function loadInitialData() {
            const token = localStorage.getItem('authToken');
            if (token) {
                try {
                    const response = await fetch('/api/roadmap', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            roadmapData = data;
                        }
                    } else {
                        localStorage.removeItem('authToken'); // Token inv√°lido, limpa
                    }
                } catch (error) {
                    console.error('N√£o foi poss√≠vel carregar os dados do usu√°rio.', error);
                }
            }
            renderApp(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();

            // --- Sidebar Toggle Listeners ---
            document.getElementById('sidebar-toggle-open').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('sidebar-toggle-close').addEventListener('click', () => toggleSidebar(false));
            document.getElementById('sidebar-overlay').addEventListener('click', () => toggleSidebar(false));

            const sidebar = document.getElementById('sidebar');
            const resizer = document.getElementById('resizer');
            const mainContent = document.getElementById('main-content');
            const minWidth = 200; 
            const maxWidth = 500; 

            function setMainContentMargin() {
                if (window.innerWidth < 768) { // md breakpoint
                    mainContent.style.marginLeft = '0px';
                } else {
                    mainContent.style.marginLeft = sidebar.style.width;
                    resizer.style.left = sidebar.style.width;
                }
            }

            setMainContentMargin();
            window.addEventListener('resize', setMainContentMargin);

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.body.classList.add('resizing');

                const mouseMoveHandler = (moveEvent) => {
                    let newWidth = moveEvent.clientX;
                    if (newWidth < minWidth) newWidth = minWidth;
                    if (newWidth > maxWidth) newWidth = maxWidth;

                    sidebar.style.width = `${newWidth}px`;
                    setMainContentMargin();
                };

                const mouseUpHandler = () => {
                    document.body.classList.remove('resizing');
                    window.removeEventListener('mousemove', mouseMoveHandler);
                    window.removeEventListener('mouseup', mouseUpHandler);

     
                    if (overallChartInstance) overallChartInstance.resize();
                    if (phaseChartInstance) phaseChartInstance.resize();
                };

                window.addEventListener('mousemove', mouseMoveHandler);
                window.addEventListener('mouseup', mouseUpHandler);
            });

            const roadmapContentEl = document.getElementById('roadmap-content');
            let draggedPath = null;

            roadmapContentEl.addEventListener('dragstart', e => {
                const li = e.target.closest('li[draggable="true"]');
                if (li) {
                    draggedPath = li.dataset.path;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedPath);
                    setTimeout(() => li.classList.add('dragging'), 0);
                }
            });

            roadmapContentEl.addEventListener('dragend', e => {
                const li = e.target.closest('li[draggable="true"]');
                if (li) {
                    li.classList.remove('dragging');
                }
                document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
                draggedPath = null;
            });

            roadmapContentEl.addEventListener('dragover', e => {
                e.preventDefault();
                const dropTarget = e.target.closest('li[draggable="true"]');
                
                document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
                if (!dropTarget || !draggedPath || dropTarget.dataset.path === draggedPath || (dropTarget.dataset.path && dropTarget.dataset.path.startsWith(draggedPath + ','))) {
                    return;
                }

                const rect = dropTarget.getBoundingClientRect();
                const y = e.clientY - rect.top;
                
                const dropIndicator = document.createElement('div');
                dropIndicator.className = 'drop-indicator';

                if (y < rect.height / 2) {
                    dropTarget.before(dropIndicator);
                    dropTarget.dataset.dropPosition = 'before';
                } else {
                    dropTarget.after(dropIndicator);
                    dropTarget.dataset.dropPosition = 'after';
                }
            });

            roadmapContentEl.addEventListener('drop', e => {
                e.preventDefault();
                const dropTarget = e.target.closest('li[draggable="true"]');
                if (!dropTarget || !draggedPath) return;
                const targetPath = dropTarget.dataset.path;
                const dropPosition = dropTarget.dataset.dropPosition;
                if (targetPath && draggedPath !== targetPath && !targetPath.startsWith(draggedPath + ',')) {
                    moveItem(draggedPath, targetPath, dropPosition);
                    renderApp();
                }
            });

            window.addEventListener('scroll', () => {
                let current = '';
                const pageYOffset = window.pageYOffset;
                const viewportHeight = window.innerHeight;
                const bodyHeight = document.body.scrollHeight;

                const offset = viewportHeight / 3;

                document.querySelectorAll('#roadmap-content section').forEach(section => {
                    if (pageYOffset >= section.offsetTop - offset) {
                        current = section.getAttribute('id');
                    }
                });

                if (pageYOffset + viewportHeight >= bodyHeight - 5) { 
                    const lastSection = document.querySelector('#roadmap-content section:last-child');
                    if (lastSection) {
                        current = lastSection.getAttribute('id');
                    }
                }

                document.querySelectorAll('#sidebar-nav a').forEach(link => {
                    link.classList.toggle('bg-teal-50', link.getAttribute('href').substring(1) === current);
                    link.classList.toggle('text-teal-700', link.getAttribute('href').substring(1) === current);
                    link.classList.toggle('font-semibold', link.getAttribute('href').substring(1) === current);
                });
            });
        });
    </script>

</body>
</html>
